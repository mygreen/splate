<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TemplateLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">splate</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.splate</a> &gt; <span class="el_source">TemplateLoader.java</span></div><h1>TemplateLoader.java</h1><pre class="source lang-java linenums">package com.github.mygreen.splate;

import java.io.IOException;
import java.util.Optional;

import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.util.StringUtils;

/**
 * SQLテンプレートのファイルを読み込む処理です。
 * &lt;p&gt;{@literal suffixName} が指定されている場合、接尾語がついているリソースを優先して読み込みます。&lt;/p&gt;
 *
 *
 * @author T.TSUCHIE
 *
 */
<span class="fc" id="L18">public class TemplateLoader {</span>

    /**
     * リソースを指定して読み込む。
     * @param resource リソース
     * @param encoding 文字コード
     * @return SQLファイルの内容
     * @throws TwoWaySqlException テンプレートの読み込みに失敗した場合にスローされます。
     */
    public String loadByResource(final Resource resource, final String encoding) {
        try {
<span class="fc" id="L29">            return SqlUtils.readStream(resource.getInputStream(), encoding);</span>
<span class="nc" id="L30">        } catch(IOException e) {</span>
<span class="nc" id="L31">            throw new TwoWaySqlException(&quot;Fail load resource&quot;, e);</span>
        }
    }

    /**
     * リソースパスを指定して読み込む。
     * {@literal suffixName} が指定されている場合、接尾語付きのリソースを優先して読み込みます。
     *
     * @param location リロースパス
     * @param resourceLoader リロースローダー。
     * @param encoding 文字コード
     * @param suffixName リロースの接尾語
     * @return SQLファイルの内容
     * @throws TwoWaySqlException テンプレートの読み込みに失敗した場合にスローされます。
     */
    public String loadByLocation(final String location,
            final ResourceLoader resourceLoader, final String encoding, final Optional&lt;String&gt; suffixName) {

<span class="fc bfc" id="L49" title="All 2 branches covered.">        if(suffixName.isPresent()) {</span>
            // 接尾語付きパスの読み込み
<span class="fc" id="L51">            String suffixedPath = convertPathWithSuffixed(location, suffixName.get());</span>
            try {
<span class="fc" id="L53">                Resource resource = resourceLoader.getResource(suffixedPath);</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">                if(resource.isReadable()) {</span>
<span class="fc" id="L55">                    return SqlUtils.readStream(resource.getInputStream(), encoding);</span>
                }
<span class="nc" id="L57">            } catch(IOException e) {</span>
                // 読み込めない場合
<span class="nc" id="L59">                throw new TwoWaySqlException(String.format(&quot;Fail load file : %s&quot;, suffixedPath), e);</span>

<span class="fc" id="L61">            }</span>
        }

        // 元々のパスでの読み込み
        try {
<span class="fc" id="L66">            Resource resource = resourceLoader.getResource(location);</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">            if(resource.isReadable()) {</span>
<span class="fc" id="L68">                return SqlUtils.readStream(resource.getInputStream(), encoding);</span>
            }

<span class="nc" id="L71">        } catch(IOException e) {</span>
            // 読み込めない場合
<span class="nc" id="L73">            throw new TwoWaySqlException(String.format(&quot;Fail load file : %s&quot;, location), e);</span>

<span class="nc" id="L75">        }</span>

        // 読み込み対象のファイルが見つからない場合
<span class="nc" id="L78">        throw new TwoWaySqlException(String.format(&quot;Not found or non-readable file : %s&quot;, location));</span>

    }

    /**
     * SQLのパスを接尾語付きのパスに変換する。
     * @param location 変換対象のパス
     * @param suffixName リロースの接尾語
     * @return 変換したパス
     */
    protected String convertPathWithSuffixed(final String location, final String suffixName) {

<span class="fc" id="L90">        final StringBuilder sb = new StringBuilder(location.length());</span>

<span class="fc" id="L92">        final String extension = StringUtils.getFilenameExtension(location);</span>

        // 拡張子を除いたファイル名に方言名を付ける
<span class="fc" id="L95">        sb.append(StringUtils.stripFilenameExtension(location))</span>
<span class="fc" id="L96">            .append(&quot;-&quot;).append(suffixName);</span>

        // 拡張子がある場合は戻す。
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if(!StringUtils.isEmpty(extension)) {</span>
<span class="fc" id="L100">            sb.append(&quot;.&quot;).append(extension);</span>
        }

<span class="fc" id="L103">        return sb.toString();</span>

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>